SYS=$(shell gcc -dumpmachine)

ifneq (,$(findstring,mingw,$(SYS)))
	STATIC=-static
endif

CXX=@CXX@
LD=@CXX@

LIBS=@APP_LIBS@
LIBS+=@LIBS@

CXXFLAGS+=@APP_CXXFLAGS@

LDFLAGS=@LDFLAGS@
LDFLAGS+=@APP_LDFLAGS@

INCLUDEDIRS=@CPPFLAGS@
INCLUDEDIRS+=@APP_CPPFLAGS@

EXT=@EXEEXT@

srcdir=@srcdir@
VPATH=@srcdir@

INCLUDEDIRS+=-I$(srcdir)


OBJECTS=gimg.o elapsedtime.o

LIBOBJECTS=gimage.o jpegimage.o jpegexif.o rawimage.o tiffimage.o strutil.o curve.o

gimg: $(OBJECTS)  libgimage.a
	$(CXX) $(LDFLAGS) $(STATIC) -o gimg$(EXT)  $(OBJECTS) libgimage.a  $(LIBS) 

libgimage.a: $(LIBOBJECTS)
	rm -f libgimage.a
	ar rcs $@ $(LIBOBJECTS)
	ranlib $@

gimg.o: gimg.cpp
	$(CXX) $(CXXFLAGS) $(INCLUDEDIRS) -c $(srcdir)/gimg.cpp -o$@

gimage.o: gimage.cpp
	$(CXX) $(CXXFLAGS) $(INCLUDEDIRS) -c $(srcdir)/gimage.cpp -o$@

tiffimage.o: $(srcdir)/tiffimage.cpp 
	$(CXX) $(CXXFLAGS) $(INCLUDEDIRS) -c $(srcdir)/tiffimage.cpp -o$@

rawimage.o: $(srcdir)/rawimage.cpp 
	$(CXX) $(CXXFLAGS) $(INCLUDEDIRS) -c $(srcdir)/rawimage.cpp -o$@

jpegimage.o: $(srcdir)/jpegimage.cpp 
	$(CXX) $(CXXFLAGS) $(INCLUDEDIRS) -c $(srcdir)/jpegimage.cpp -o$@

jpegexif.o: $(srcdir)/jpegexif.cpp 
	$(CXX) $(CXXFLAGS) $(INCLUDEDIRS) -c $(srcdir)/jpegexif.cpp -o$@

elapsedtime.o: $(srcdir)/elapsedtime.cpp 
	$(CXX) $(CXXFLAGS) $(INCLUDEDIRS) -c $(srcdir)/elapsedtime.cpp -o$@

strutil.o: $(srcdir)/strutil.cpp 
	$(CXX) $(CXXFLAGS) $(INCLUDEDIRS) -c $(srcdir)/strutil.cpp -o$@

curve.o: $(srcdir)/curve.cpp 
	$(CXX) $(CXXFLAGS) $(INCLUDEDIRS) -c  $(srcdir)/curve.cpp -o$@

.PHONY: clean
clean:
	rm -rf *.o *.a gimg$(EXT)

.PHONY: install
install:
	test -d $(DESTDIR)/usr/local/bin || install -d $(DESTDIR)/usr/local/bin/
	test -d $(DESTDIR)/usr/local/lib || install -d $(DESTDIR)/usr/local/lib/
	test -d $(DESTDIR)/usr/local/include/gimage || install -d $(DESTDIR)/usr/local/include/gimage
	install -m 755 gimg$(EXT) $(DESTDIR)/usr/local/bin/gimg$(EXT)
	install -m 644 libgimage.a $(DESTDIR)/usr/local/lib/libgimage.a
	install -m 644 $(srcdir)/gimage/gimage.h $(DESTDIR)/usr/local/include/gimage/
	install -m 644 $(srcdir)/gimage/curve.h $(DESTDIR)/usr/local/include/gimage/
	install -m 644 $(srcdir)/gimage/half.hpp $(DESTDIR)/usr/local/include/gimage/
	install -m 644 $(srcdir)/gimage/strutil.h $(DESTDIR)/usr/local/include/gimage/

.PHONY: uninstall
uninstall:
	rm -rf $(DESTDIR)/usr/local/include/gimage
	rm -f  $(DESTDIR)/usr/local/bin/gimg$(EXT)
	rm -f  $(DESTDIR)/usr/local/lib/libgimage.a
