SYS=$(shell gcc -dumpmachine)

ifneq (,$(findstring,mingw,$(SYS)))
	STATIC=-static
endif

CXX=@CXX@
LD=@CXX@

LIBS=@LIBS@
INCLUDEDIRS=
CFLAGS=@CFLAGS@
CXXFLAGS=@CXXFLAGS@
LDFLAGS=@LDFLAGS@
INCLUDEDIRS=@CPPFLAGS@
EXT=@EXEEXT@

srcdir=@srcdir@
VPATH=@srcdir@


OBJECTS=gimg.o elapsedtime.o

LIBOBJECTS=gimage.o jpegimage.o jpegexif.o rawimage.o tiffimage.o strutil.o curve.o

gimg: $(OBJECTS)  libgimage.a
	$(CXX) $(LDFLAGS) $(STATIC) -o gimg$(EXT)  $(OBJECTS) libgimage.a  $(LIBS) 

libgimage.a: $(LIBOBJECTS)
	rm -f libgimage.a
	ar rcs $@ $(LIBOBJECTS)
	ranlib $@

gimg.o: gimg.cpp
	$(CXX) $(CXXFLAGS) $(INCLUDEDIRS) -DLIBRAW_NODLL -c $(srcdir)/gimg.cpp -o$@

gimage.o: gimage.cpp
	$(CXX) $(CXXFLAGS) $(INCLUDEDIRS) -DLIBRAW_NODLL -c $(srcdir)/gimage.cpp -o$@

tiffimage.o: $(srcdir)/tiffimage.cpp $(srcdir)/tiffimage.h
	$(CXX) $(CXXFLAGS) $(INCLUDEDIRS) -c $(srcdir)/tiffimage.cpp -o$@

rawimage.o: $(srcdir)/rawimage.cpp $(srcdir)/rawimage.h
	$(CXX) $(CXXFLAGS) $(INCLUDEDIRS) -DLIBRAW_NODLL -c $(srcdir)/rawimage.cpp -o$@

jpegimage.o: $(srcdir)/jpegimage.cpp $(srcdir)/jpegimage.h
	$(CXX) $(CXXFLAGS) $(INCLUDEDIRS) -c $(srcdir)/jpegimage.cpp -o$@

jpegexif.o: $(srcdir)/jpegexif.cpp $(srcdir)/jpegexif.h
	$(CXX) $(CXXFLAGS) $(INCLUDEDIRS) -c $(srcdir)/jpegexif.cpp -o$@

elapsedtime.o: $(srcdir)/elapsedtime.cpp $(srcdir)/elapsedtime.h
	$(CXX) $(CXXFLAGS) $(INCLUDEDIRS) -c $(srcdir)/elapsedtime.cpp -o$@

strutil.o: $(srcdir)/strutil.cpp $(srcdir)/strutil.h
	$(CXX) $(CXXFLAGS) $(INCLUDEDIRS) -c $(srcdir)/strutil.cpp -o$@

curve.o: $(srcdir)/curve.cpp $(srcdir)/curve.h
	$(CXX) $(CXXFLAGS) $(INCLUDEDIRS) -c  $(srcdir)/curve.cpp -o$@

.PHONY: clean
clean:
	rm -rf *.o *.a gimg$(EXT)

.PHONY: install
install:
	test -d $(DESTDIR)/usr/local/bin || install -d $(DESTDIR)/usr/local/bin/
	test -d $(DESTDIR)/usr/local/lib || install -d $(DESTDIR)/usr/local/lib/
	test -d $(DESTDIR)/usr/local/include/gimage || install -d $(DESTDIR)/usr/local/include/gimage
	install -m 755 gimg$(EXT) $(DESTDIR)/usr/local/bin/gimg$(EXT)
	install -m 644 libgimage.a $(DESTDIR)/usr/local/lib/libgimage.a
	install -m 644 $(srcdir)/gimage.h $(DESTDIR)/usr/local/include/gimage/
	install -m 644 $(srcdir)/curve.h $(DESTDIR)/usr/local/include/gimage/
	install -m 644 $(srcdir)/half.hpp $(DESTDIR)/usr/local/include/gimage/
	install -m 644 $(srcdir)/strutil.h $(DESTDIR)/usr/local/include/gimage/

.PHONY: uninstall
uninstall:
	rm -rf $(DESTDIR)/usr/local/include/gimage
	rm -f  $(DESTDIR)/usr/local/bin/gimg$(EXT)
	rm -f  $(DESTDIR)/usr/local/lib/libgimage.a
